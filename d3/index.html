<!DOCTYPE html>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">

<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="../contributors.js"></script>
<script>
// var nodes = [
//   { id: "mammal", group: 0, label: "Mammals", level: 1 },
//   { id: "dog"   , group: 0, label: "Dogs"   , level: 2 },
//   { id: "cat"   , group: 0, label: "Cats"   , level: 2 },
//   { id: "fox"   , group: 0, label: "Foxes"  , level: 2 },
//   { id: "elk"   , group: 0, label: "Elk"    , level: 2 },
//   { id: "insect", group: 1, label: "Insects", level: 1 },
//   { id: "ant"   , group: 1, label: "Ants"   , level: 2 },
//   { id: "bee"   , group: 1, label: "Bees"   , level: 2 },
//   { id: "fish"  , group: 2, label: "Fish"   , level: 1 },
//   { id: "carp"  , group: 2, label: "Carp"   , level: 2 },
//   { id: "pike"  , group: 2, label: "Pikes"  , level: 2 }
// ]
// var links = [
// 	{ target: "mammal", source: "dog" , strength: 0.7 },
// 	{ target: "mammal", source: "cat" , strength: 0.7 },
//   { target: "mammal", source: "fox" , strength: 0.7 },
//   { target: "mammal", source: "elk" , strength: 0.7 },
//   { target: "insect", source: "ant" , strength: 0.7 },
//   { target: "insect", source: "bee" , strength: 0.7 },
//   { target: "fish"  , source: "carp", strength: 0.7 },
//   { target: "fish"  , source: "pike", strength: 0.7 },
//   { target: "cat"   , source: "elk" , strength: 0.1 },
//   { target: "carp"  , source: "ant" , strength: 0.1 },
//   { target: "elk"   , source: "bee" , strength: 0.1 },
//   { target: "dog"   , source: "cat" , strength: 0.1 },
//   { target: "fox"   , source: "ant" , strength: 0.1 },
// 	{ target: "pike"  , source: "cat" , strength: 0.1 }
// ]

var nodes = [];
var links = [];

(function initialize(){
    console.log('initializing')
    contributors.forEach(function(node){
        nodes.push({
            id:node.id,
            label:node.name,
            level:2
        });
        node.connections.forEach(function(con){
            links.push({
                target:con,
                source:node.id,
                strength:0.1
            })
        })
    })
})();

// var nodes = [{
//         id: "shahira",
//         label: "Shahira",
//         level: 2
//     }, {
//         id: "dane",
//         label: "Dane",
//         level: 2
//     }, {
//         id: "jahmal",
//         label: "Jahmal",
//         level: 2
//     }, {
//         id: "lydon",
//         label: "Lydon",
//         level: 2
//     }, {
//         id: "dog",
//         label: "Dane's dog (fictional)",
//         level: 2
//     }, {
//         id: "snake",
//         label: "Jahmal's snake"
//     }

// ]
// var links = [{
//         target: "dane",
//         source: "shahira",
//         strength: 0.2
//     }, {
//         target: "jahmal",
//         source: "dane",
//         strength: 0.2
//     }, {
//         target: "shahira",
//         source: "jahmal",
//         strength: 0.2
//     }, {
//         target: "shahira",
//         source: "lydon",
//         strength: 0.2
//     }, {
//         target: "dane",
//         source: "dog",
//         strength: 0.2
//     }, {
//         target: "lydon",
//         source: "jahmal",
//         strength: 0.2
//     }, {
//         target: "jahmal",
//         source: "snake",
//         strength: 0.2
//     }

// ]


function getNeighbors(node) {
    return links.reduce(function(neighbors, link) {
        if (link.target.id === node.id) {
            neighbors.push(link.source.id)
        } else if (link.source.id === node.id) {
            neighbors.push(link.target.id)
        }
        return neighbors
    }, [node.id])
}

function isNeighborLink(node, link) {
    return link.target.id === node.id || link.source.id === node.id
}

function getNodeColor(node, neighbors) {
    if (Array.isArray(neighbors) && neighbors.indexOf(node.id) > -1) {
        return node.level === 1 ? 'blue' : 'blue'
    }
    return node.level === 1 ? 'red' : 'gray'
}


function setSelectedColor(node, selectedNode) {
    return node == selectedNode ? 'blue' : 'black'
}

function getLinkColor(node, link) {
    return isNeighborLink(node, link) ? 'blue' : '#E5E5E5'
}

function getTextColor(node, neighbors) {
    return Array.isArray(neighbors) && neighbors.indexOf(node.id) > -1 ? 'green' : 'black'
}


var width = window.innerWidth
var height = window.innerHeight
var svg = d3.select('svg')
svg.attr('width', width).attr('height', height)
    // simulation setup with all forces
var linkForce = d3
    .forceLink()
    .id(function(link) {
        return link.id
    })
    .strength(function(link) {
        return link.strength
    })
var simulation = d3
    .forceSimulation()
    .force('link', linkForce)
    .force('charge', d3.forceManyBody().strength(-1120))
    .force('center', d3.forceCenter(width / 2, height / 2))
var dragDrop = d3.drag().on('start', function(node) {
    node.fx = node.x
    node.fy = node.y
}).on('drag', function(node) {
    simulation.alphaTarget(0.7).restart()
    node.fx = d3.event.x
    node.fy = d3.event.y
}).on('end', function(node) {
    if (!d3.event.active) {
        simulation.alphaTarget(0)
    }
    node.fx = null
    node.fy = null
})

function selectNode(selectedNode) {
    var neighbors = getNeighbors(selectedNode)
        // we modify the styles to highlight selected nodes
    nodeElements.attr('fill', function(node) {
            return getNodeColor(node, neighbors)
        })
        textElements.attr('fill', function (node) { return setSelectedColor(node, selectedNode) })
    linkElements.attr('stroke', function(link) {
        return getLinkColor(selectedNode, link)
    })
}


window.onload = function() {
    linkElements = svg.append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("stroke-width", 1)
        .attr("stroke", "rgba(50, 50, 50, 0.2)")
    nodeElements = svg.append("g")
        .attr("class", "nodes")
        .selectAll("circle")
        .data(nodes)
        .enter().append("circle")
        .attr("r", 10)
        .attr("fill", getNodeColor)
        .call(dragDrop)
        .on('click', selectNode)
    textElements = svg.append("g")
        .attr("class", "texts")
        .selectAll("text")
        .data(nodes)
        .enter().append("text")
        .text(function(node) {
            return node.label
        })
        .attr("font-size", 25)
        .attr("font-family", 'Raleway')
        .attr("dx", 15)
        .attr("dy", 4)

    simulation.nodes(nodes).on('tick', () => {
        nodeElements
            .attr('cx', function(node) {
                return node.x
            })
            .attr('cy', function(node) {
                return node.y
            })
        textElements
            .attr('x', function(node) {
                return node.x
            })
            .attr('y', function(node) {
                return node.y
            })
        linkElements
            .attr('x1', function(link) {
                return link.source.x
            })
            .attr('y1', function(link) {
                return link.source.y
            })
            .attr('x2', function(link) {
                return link.target.x
            })
            .attr('y2', function(link) {
                return link.target.y
            })
    })
    simulation.force("link").links(links)

}

</script>