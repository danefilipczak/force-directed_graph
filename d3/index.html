<!DOCTYPE html>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">

<svg width="960" height="600"></svg>
<div class="bio"></div>
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous">
</script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="../contributors.js"></script>

<style>
.bio{
    position:fixed;
    top:0px;
    left:0px;
    font-family:'Raleway';
    font-size:20px;
    width:38.2%;
    margin:10px;
}
</style>
<script>

var nodes = [];
var links = [];

(function initialize(){
    contributors.forEach(function(node){
        nodes.push({
            id:node.id,
            label:node.name,
            level:2
        });
        node.connections.forEach(function(con){
            links.push({
                target:con,
                source:node.id,
                strength:0.005
            })
        })
    })
})();


function getNeighbors(node) {
    return links.reduce(function(neighbors, link) {
        if (link.target.id === node.id) {
            neighbors.push(link.source.id)
        } else if (link.source.id === node.id) {
            neighbors.push(link.target.id)
        }
        return neighbors
    }, [node.id])
}

function isNeighborLink(node, link) {
    return link.target.id === node.id || link.source.id === node.id
}

function getNodeColor(node, neighbors) {
    if (Array.isArray(neighbors) && neighbors.indexOf(node.id) > -1) {
        return node.level === 1 ? 'blue' : 'blue'
    }
    return node.level === 1 ? 'red' : 'gray'
}


function setSelectedColor(node, selectedNode) {
    return node == selectedNode ? 'blue' : 'black'
}

function getLinkColor(node, link) {
    return isNeighborLink(node, link) ? 'blue' : '#E5E5E5'
}

function getTextColor(node, neighbors) {
    return Array.isArray(neighbors) && neighbors.indexOf(node.id) > -1 ? 'green' : 'black'
}

var svg;
function sizeCanvas() {
    var width = window.innerWidth
    var height = window.innerHeight
    svg = d3.select('svg')
    svg.attr('width', width).attr('height', height)
};


    // simulation setup with all forces
var linkForce = d3
    .forceLink()
    .id(function(link) {
        return link.id
    })
    .strength(function(link) {
        return link.strength
    })
var simulation = d3
    .forceSimulation()
    .force('link', linkForce)
    .force('charge', d3.forceManyBody().strength(-120))
    .force('center', d3.forceCenter(window.innerWidth / 2, window.innerHeight / 2))
var dragDrop = d3.drag().on('start', function(node) {
    node.fx = node.x
    node.fy = node.y
}).on('drag', function(node) {
    simulation.alphaTarget(0.7).restart()
    node.fx = d3.event.x
    node.fy = d3.event.y
}).on('end', function(node) {
    if (!d3.event.active) {
        simulation.alphaTarget(0)
    }
    node.fx = null
    node.fy = null
})

function selectNode(selectedNode) {
    $(".bio").html("a little bit of information about <strong>" + selectedNode.label + "</strong>. <br>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.")
    var neighbors = getNeighbors(selectedNode)
        // we modify the styles to highlight selected nodes
    nodeElements.attr('fill', function(node) {
            return getNodeColor(node, neighbors)
        })
        textElements.attr('fill', function (node) { return setSelectedColor(node, selectedNode) })
    linkElements.attr('stroke', function(link) {
        return getLinkColor(selectedNode, link)
    })
}


window.onload = function() {
    sizeCanvas();
    linkElements = svg.append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("stroke-width", 1)
        .attr("stroke", "rgba(50, 50, 50, 0.2)")
    nodeElements = svg.append("g")
        .attr("class", "nodes")
        .selectAll("circle")
        .data(nodes)
        .enter().append("circle")
        .attr("r", 10)
        .attr("fill", getNodeColor)
        .call(dragDrop)
        .on('click', selectNode)
    textElements = svg.append("g")
        .attr("class", "texts")
        .selectAll("text")
        .data(nodes)
        .enter().append("text")
        .text(function(node) {
            return node.label
        })
        .attr("font-size", 25)
        .attr("font-family", 'Raleway')
        .attr("dx", 15)
        .attr("dy", 4)

    simulation.nodes(nodes).on('tick', () => {
        nodeElements
            .attr('cx', function(node) {
                return node.x
            })
            .attr('cy', function(node) {
                return node.y
            })
        textElements
            .attr('x', function(node) {
                return node.x
            })
            .attr('y', function(node) {
                return node.y
            })
        linkElements
            .attr('x1', function(link) {
                return link.source.x
            })
            .attr('y1', function(link) {
                return link.source.y
            })
            .attr('x2', function(link) {
                return link.target.x
            })
            .attr('y2', function(link) {
                return link.target.y
            })
    })
    simulation.force("link").links(links)
    window.onresize = sizeCanvas;

}

</script>